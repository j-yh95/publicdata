<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>카카오 로드뷰</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
	<style>
	html, body {
	margin: 0;
	height: 100%;
	overflow: auto;
	}

	.map_wrap {overflow:hidden; height:90%; z-index:1}
	/* 지도위에 로드뷰의 위치와 각도를 표시하기 위한 map walker 아이콘의 스타일 */
	.MapWalker {position:absolute;margin:-26px 0 0 -51px}
	/* .MapWalker .figure {position:absolute;width:25px;left:38px;top:-2px;
		height:39px;background:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png) -298px -114px no-repeat} */
	.MapWalker .angleBack {width:102px;height:52px;background: url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png) -834px -2px no-repeat;}
	.MapWalker.m0 .figure {background-position: -298px -114px;}
	.MapWalker.m1 .figure {background-position: -335px -114px;}
	.MapWalker.m2 .figure {background-position: -372px -114px;}
	.MapWalker.m3 .figure {background-position: -409px -114px;}
	.MapWalker.m4 .figure {background-position: -446px -114px;}
	.MapWalker.m5 .figure {background-position: -483px -114px;}
	.MapWalker.m6 .figure {background-position: -520px -114px;}
	.MapWalker.m7 .figure {background-position: -557px -114px;}
	.MapWalker.m8 .figure {background-position: -2px -114px;}
	.MapWalker.m9 .figure {background-position: -39px -114px;}
	.MapWalker.m10 .figure {background-position: -76px -114px;}
	.MapWalker.m11 .figure {background-position: -113px -114px;}
	.MapWalker.m12 .figure {background-position: -150px -114px;}
	.MapWalker.m13 .figure {background-position: -187px -114px;}
	.MapWalker.m14 .figure {background-position: -224px -114px;}
	.MapWalker.m15 .figure {background-position: -261px -114px;}
	.MapWalker.m0 .angleBack {background-position: -834px -2px;}
	.MapWalker.m1 .angleBack {background-position: -938px -2px;}
	.MapWalker.m2 .angleBack {background-position: -1042px -2px;}
	.MapWalker.m3 .angleBack {background-position: -1146px -2px;}
	.MapWalker.m4 .angleBack {background-position: -1250px -2px;}
	.MapWalker.m5 .angleBack {background-position: -1354px -2px;}
	.MapWalker.m6 .angleBack {background-position: -1458px -2px;}
	.MapWalker.m7 .angleBack {background-position: -1562px -2px;}
	.MapWalker.m8 .angleBack {background-position: -2px -2px;}
	.MapWalker.m9 .angleBack {background-position: -106px -2px;}
	.MapWalker.m10 .angleBack {background-position: -210px -2px;}
	.MapWalker.m11 .angleBack {background-position: -314px -2px;}
	.MapWalker.m12 .angleBack {background-position: -418px -2px;}
	.MapWalker.m13 .angleBack {background-position: -522px -2px;}
	.MapWalker.m14 .angleBack {background-position: -626px -2px;}
	.MapWalker.m15 .angleBack {background-position: -730px -2px;}
	#rvWrapper{z-index: 2; position:absolute;}
	#roadview{z-index: 3; position:absolute;}
	#buttons{z-index: 4; position: absolute; top:5px; right:20px; }
	#map{position:absolute; overflow:auto; bottom:0px; left:0px; width:500px; height:400px; z-index:4; border:1px solid #909090;box-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);border-radius: 5px;margin:0;padding:0;visibility: hidden;}
	#rsz {position: absolute;right: 0;top: 0;width:36px;height:36px;background:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview/ico_roadview22x_190625.png) -100px -181px no-repeat;background-size:200px auto;z-index: 5; cursor:nesw-resize;}

</style>
</head>
<body>

<div id = "buttons">
		<button type="button" class = "btn btn-dark" onclick="moveKakaoRoadview()">카카오</button>
		<button type="button" class = "btn btn-dark" onclick="moveNaverStreetview()">네이버</button>
		<button type="button" class = "btn btn-dark" onclick="createAgoMarker(0)">로드뷰/마우스</button>
		<button type="button"  class = "btn btn-dark" onclick="createAgoMarker(1)">로드뷰</button>
		<button type="button" class = "btn btn-dark" onclick="createAgoMarker(2)">마우스</button>
		<button type="button" class = "btn btn-dark" onclick="removeAgoMarker()">마커 제거</button>
	</div>
</div>


<div id="pano" style="width:0px; height:0px;"></div>

<div id="mapwrap" z-index: 1;>
	<div id="roadview" style="position: absolute; left: 0px; bottom: 0px; width: 100%; height: 100%; " z-index: 2; position:absolute;></div> 
	<div id="map" style="overflow: hidden; visibility: visible; position:absolute;" z-index: 3;> 
		<div id ="rsz"></div>
		<div style="position: absolute; z-index: 1; width: 100%; height: 0px; transform: translateZ(0px);"></div>
	</div>
</div>


<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=xbdzrxswyq&submodules=panorama"></script>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=aaad5d4c64cda78f1f24f008bed01025&libraries=services"></script>
<script>

//지도위에 현재 로드뷰의 위치와, 각도를 표시하기 위한 map walker 아이콘 생성 클래스
function MapWalker(position){
	//커스텀 오버레이에 사용할 map walker 엘리먼트
	var content = document.createElement('div');
	var figure = document.createElement('div');
	var angleBack = document.createElement('div');

	//map walker를 구성하는 각 노드들의 class명을 지정 - style셋팅을 위해 필요
	content.className = 'MapWalker';
	figure.className = 'figure';
	angleBack.className = 'angleBack';

	content.appendChild(angleBack);
	content.appendChild(figure);

	//커스텀 오버레이 객체를 사용하여, map walker 아이콘을 생성
	var walker = new kakao.maps.CustomOverlay({
		position: position,
		content: content,
		yAnchor: 1
	});

	this.walker = walker;
	this.content = content;
}

//로드뷰의 pan(좌우 각도)값에 따라 map walker의 백그라운드 이미지를 변경 시키는 함수
//background로 사용할 sprite 이미지에 따라 계산 식은 달라 질 수 있음
MapWalker.prototype.setAngle = function(angle){
	var threshold = 22.5; //이미지가 변화되어야 되는(각도가 변해야되는) 임계 값
	for(var i=0; i<16; i++){ //각도에 따라 변화되는 앵글 이미지의 수가 16개
		if(angle > (threshold * i) && angle < (threshold * (i + 1))){
			//각도(pan)에 따라 아이콘의 class명을 변경
			var className = 'm' + i;
			this.content.className = this.content.className.split(' ')[0];
			this.content.className += (' ' + className);
			break;
		}
	}
};

//map walker의 위치를 변경시키는 함수
MapWalker.prototype.setPosition = function(position){
	this.walker.setPosition(position);
};

//map walker를 지도위에 올리는 함수
MapWalker.prototype.setMap = function(map){
	this.walker.setMap(map);
};

var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
	mapCenter = new kakao.maps.LatLng(37.272211, 127.435087), // 지도의 가운데 좌표
	mapOption = {
		center: mapCenter, // 지도의 중심좌표
		level: 3 // 지도의 확대 레벨
	};

// 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
var map = new kakao.maps.Map(mapContainer, mapOption);

// 로드뷰 도로를 지도위에 올린다.
map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);

var roadviewContainer = document.getElementById('roadview'); // 로드뷰를 표시할 div
var roadview = new kakao.maps.Roadview(roadviewContainer, options = {zoom:-3}); // 로드뷰 객체
var roadviewClient = new kakao.maps.RoadviewClient(); // 좌표로부터 로드뷰 파노ID를 가져올 로드뷰 helper객체

// 지도의 중심좌표와 가까운 로드뷰의 panoId를 추출하여 로드뷰를 띄운다.
roadviewClient.getNearestPanoId(mapCenter, 50, function(panoId) {
	roadview.setPanoId(panoId, mapCenter); // panoId와 중심좌표를 통해 로드뷰 실행
});

var mapWalker = null;
var marker = new kakao.maps.Marker(); 
var geocoder = new kakao.maps.services.Geocoder();

// 로드뷰의 초기화 되었을때 map walker를 생성한다.
kakao.maps.event.addListener(roadview, 'init', function() {
	mapWalker = new MapWalker(mapCenter);
	mapWalker.setMap(map); // map walker를 지도에 설정한다.

	// 로드뷰가 초기화 된 후, 추가 이벤트를 등록한다.
	kakao.maps.event.addListener(roadview, 'viewpoint_changed', function(){
		var viewpoint = roadview.getViewpoint();	// 이벤트가 발생할 때마다 로드뷰의 viewpoint값을 읽어, map walker에 반영
		mapWalker.setAngle(viewpoint.pan);
	});

	// 로드뷰내의 화살표나 점프를 하였을 경우 발생한다.
	kakao.maps.event.addListener(roadview, 'position_changed', function(){
		var position = roadview.getPosition();
		mapWalker.setPosition(position);
		map.setCenter(position);

		var roadViewCarAddress = '';
		roadViewCarAddress = position
		searchDetailAddrFromCoords(position, function(result, status) {
			if (status === kakao.maps.services.Status.OK) {
				var address = result[0].address.address_name
				var roadViewCarAddress = address + '\t' + position['Ha'] + '\t' + position['Ga'];
			}
		});

		lat = position['Ha'];
		lng = position['Ga'];
		query_string = lat + "," + lng
		gps_sending('1', query_string);
	});

	//맵 좌클릭시 로드뷰 이동 
	kakao.maps.event.addListener(map, 'click', function(mouseEvent){
		var position = mouseEvent.latLng; 
		mapWalker.setPosition(position);
		toggleRoadview(position, roadview.getPosition());
});

	//맵 우클릭시 위치의 주소 GPS 좌표 반환한다.
	marker.setMap(map);
	kakao.maps.event.addListener(map, 'rightclick', function(mouseEvent) {
		var fullAddress = ''
		var latlng = mouseEvent.latLng; 
		marker.setPosition(latlng);
	
		lat = latlng['Ha'];
		lng = latlng['Ga'];
		query_string = lat + "," + lng
		gps_sending('2', query_string);

		// gps_sending(query_string);

		searchDetailAddrFromCoords(mouseEvent.latLng, function(result, status) {
			if (status === kakao.maps.services.Status.OK) {
				var address = result[0].address.address_name
				var markerAddress = address + '\t' + latlng.getLat() + '\t' + latlng.getLng();
				// var resultDiv = document.getElementById('markerAddress'); 
				// resultDiv.innerHTML = markerAddress;
				copyToClipboard(markerAddress);
			}
		});
	});
});

//미니맵 리사이징
var doc = document;
var ht = 400;
var wd = 400;
var main = document.querySelector('#map'), x, y, dx, dy;

var startResize = function(event){
	x = event.screenX;
	y = event.screenY;
};

var resize = function(event){
	dx = event.screenX - x;
	dy = event.screenY - y;
	x = event.screenX;
	y = event.screenY;
	wd += dx;
	ht -= dy;
	main.style.width = wd + "px";
	main.style.height = ht + "px";

	map.relayout();
	var position = roadview.getPosition();
	mapWalker.setPosition(position);
	map.setCenter(position);
};

rsz.addEventListener("mousedown", function(event){
	startResize(event);
	doc.body.addEventListener("mousemove", resize);
	doc.body.addEventListener("mouseup", function(){
	doc.body.removeEventListener("mousemove", resize);
	});
	// resize 이벤트가 종료된 후 로드뷰의 중앙으로 지도 옮기기

});


function copyToClipboard(text) {
  var input = document.body.appendChild(document.createElement("input"));
  input.value = text;
  input.focus();
  input.select();
  document.execCommand('copy');
  input.parentNode.removeChild(input);
}
//Reverse Geocoding
function searchDetailAddrFromCoords(coords, callback) {
    geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
}

//전달받은 좌표(position)에 가까운 로드뷰의 panoId를 추출하여 로드뷰를 띄웁니다
function toggleRoadview(position, roadViewCarAddress){
roadviewClient.getNearestPanoId(position, 50, function(panoId) {
	if (panoId === null) {
		mapWalker.setPosition(roadViewCarAddress);
		// roadviewContainer.style.display = 'none'; //로드뷰를 넣은 컨테이너를 숨깁니다
		// mapWrapper.style.width = '40%';
		// map.relayout();
	} else {
		// map.style.width = '100%';
		map.relayout(); //지도를 감싸고 있는 영역이 변경됨에 따라, 지도를 재배열합니다
		roadviewContainer.style.display = 'block'; //로드뷰를 넣은 컨테이너를 보이게합니다
		roadview.setPanoId(panoId, position); //panoId를 통한 로드뷰 실행
		roadview.relayout(); //로드뷰를 감싸고 있는 영역이 변경됨에 따라, 로드뷰를 재배열합니다
	}
});
}

var polygons = []

//법정동 geoJSON 받아오기
$.getJSON("/data/icheon_dong.json", function(geoJson){
	var data = geoJson.features;
	var coordinates = [];
	var name = ''
		$.each(data, function(index, val){
			coordinates = val.geometry.coordinates;	//WGS84
			name = val.properties.EMD_NM;			//동(ex: 경기도 이천시 증포동)

			displayDongArea(name, coordinates);
		})
    });

//법정리 geoJSON 받아오기
$.getJSON("/data/icheon_li.json", function(geoJson){
var data = geoJson.features;
var coordinates = [];
var name = ''
	$.each(data, function(index, val){
		coordinates = val.geometry.coordinates;	//WGS84
		name = val.properties.RI_NM;			//동(ex: 경기도 이천시 증포동)

		displayLiArea(name, coordinates);
	})
});

//법정동 폴리곤 생성
function displayDongArea(name, coordinates){
	var path = [];
	var points = [];

	$.each(coordinates[0], function(index, coordinate){
		var point = new Object();
		point.x = coordinate[1];
		point.y = coordinate[0];
		points.push(point);
		path.push(new daum.maps.LatLng(coordinate[1], coordinate[0]));
	})

	var polygon = new daum.maps.Polygon({
        map: map, // 다각형을 표시할 지도 객체
        path: path,
        strokeWeight: 2,
        strokeColor: '#004c80',
        strokeOpacity: 0.8,
        fillColor: '#09f',
        fillOpacity: 0.1
	});

	polygons.push(polygon);

	//법정동명 표시
	var polygon_center = centeroid(points); 
	var content = '<div class ="label" style ="color:black; font-weight:bold; background-color: rgba( 255, 255, 0, 0.3 );><span class="left"></span><span class="center">' + name + '</span><span class="right"></span></div>';
	var position = new kakao.maps.LatLng(polygon_center['Ha'], polygon_center['Ga']);  
	var customOverlay = new kakao.maps.CustomOverlay({
	    position: position,
    	content: content   
	});

	customOverlay.setMap(map);

    kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
        polygon.setOptions({fillColor: '#fff'});
    });
    kakao.maps.event.addListener(polygon, 'mouseout', function() {
        polygon.setOptions({fillColor: '#09f'});
    }); 
}

function displayLiArea(name, coordinates){
	var path = [];
	var points = [];

	$.each(coordinates[0], function(index, coordinate){
		var point = new Object();
		point.x = coordinate[1];
		point.y = coordinate[0];
		points.push(point);
		path.push(new daum.maps.LatLng(coordinate[1], coordinate[0]));
	})

	var polygon = new daum.maps.Polygon({
        map: map, // 다각형을 표시할 지도 객체
        path: path,
        strokeWeight: 0.6,
        strokeColor: '#ff0f01',
        strokeOpacity: 0.8,
        fillColor: '#09f',
        fillOpacity: 0
	});

	polygons.push(polygon);

	//법정리에 법정리명 표시
	var polygon_center = centeroid(points);

	var content = '<div class ="label" style ="color:white; font-size: small; background-color: rgba( 10, 10, 10, 0.3 );><span class="left"></span><span class="center">' + name + '</span><span class="right"></span></div>';
	var position = new kakao.maps.LatLng(polygon_center['Ha'], polygon_center['Ga']);  
	var customOverlay = new kakao.maps.CustomOverlay({
	    position: position,
    	content: content   
	});
	customOverlay.setMap(map);
}

//index 1 : 로드뷰, index 2 : 우클릭
function gps_sending(index, query_string){
	$(function () {
			var ajax = $.ajax({
			type: "GET",
			url: "kakao_gps_travle.php?gps="+index+','+ query_string
			});
			ajax.done(function (query_string) {
				$(".console-area").html(query_string);
			});
		});
}

function centeroid(points){
	var i, j, len, p1, p2, f, area, x, y;

	area = x = y = 0

	for (i=0, len = points.length, j= len - 1; i < len; j = i++){
		p1 = points[i];
		p2 = points[j];

		f = p1.y * p2.x - p2.y * p1.x;
		x += (p1.x + p2.x) * f;
		y += (p1.y + p2.y) * f;
		area += f * 3;
	}return new kakao.maps.LatLng(x / area, y / area);
}

// function changeRoadview(){
// 	var gpsAddress = document.getElementById("roadViewChanger").gpsAddress.value;
// 	gpsAddress = gpsAddress.split(",")
// 	var position = new kakao.maps.LatLng(gpsAddress[0], gpsAddress[1]);
// 	roadviewClient.getNearestPanoId(position, 50, function(panoId) {
// 		roadview.setPanoId(panoId, position);
// 		console.log(position);
// 	});
// }

function moveKakaoRoadview(){
	var panoId = roadview.getPanoId();
	window.open('https://map.kakao.com/?panoid='+panoId);
}

function moveNaverStreetview(){
	var coords = roadview.getPosition();
	var pano = null;
	var pano = new naver.maps.Panorama("pano", {
		position: new naver.maps.LatLng(coords['Ha'], coords['Ga'])
	})
	naver.maps.Event.addListener(pano, "pano_changed", function() {
		var streetviewUrl = "https://map.naver.com/v5/?c=14185421.9777121,4477822.3462987,17,0,0,0,dha&p="
		streetviewUrl = streetviewUrl + pano.getPanoId() + ',0,0,80,Float';	
		window.open(streetviewUrl);
	});
}

var markers = [];
function createAgoMarker(optionIndex){
	var date = new Date();
	var nowYearDateTime = String(date.getFullYear()) + String(date.getMonth() + 1) + String(date.getDate());
	var gpsFilePathName = "/data/log/roadview_log/" + nowYearDateTime + "total_gps.log"
	
	var httpRequest = new XMLHttpRequest();
	httpRequest.open('GET', gpsFilePathName);
	httpRequest.send();

	httpRequest.onload = function(){
		if(httpRequest.status == 200){
			var gps_array = httpRequest.responseText;
			gps_array = gps_array.split("\n")

			//중복 제거
			var unique_gps_array = [];
			$.each(gps_array, function(i, el){
				if($.inArray(el, unique_gps_array) === -1) unique_gps_array.push(el);
			});
			//마커 찍기
			for (var i = 0; i < unique_gps_array.length; i++) {
				if (unique_gps_array[i] != "") {
					gps = unique_gps_array[i].split(',');
					if(optionIndex == "0"){
						var markerPosition = new kakao.maps.LatLng(gps[1], gps[2]);
						var marker = new kakao.maps.Marker({
							map: map, // 마커를 표시할 지도
							position: markerPosition // 마커의 위치
						});
						markers.push(marker);
					}else if(optionIndex == "1"){
						if(gps[0] == "1"){
							var markerPosition = new kakao.maps.LatLng(gps[1], gps[2]);
							var marker = new kakao.maps.Marker({
								map: map, // 마커를 표시할 지도
								position: markerPosition // 마커의 위치
							});
							markers.push(marker);
						}
					}else if(optionIndex == "2"){
						if(gps[0] == "2"){
							var markerPosition = new kakao.maps.LatLng(gps[1], gps[2]);
							var marker = new kakao.maps.Marker({
								map: map, // 마커를 표시할 지도
								position: markerPosition // 마커의 위치
							});
							markers.push(marker);
						}
					}
				}
			}
		}
	}
}

function removeAgoMarker(){
	for(var i=0; i < markers.length; i++){
		markers[i].setMap(null);		
	}
	markers = [];
}

</script>
</body>
</html>