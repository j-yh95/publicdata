<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>네이버 거리뷰 탐색</title>
</head>

<style type="text/css">
    html,
    body {
        margin: 0;
        height: 100%;
        overflow: hidden;
    }
    div#pano {
        width: 100%;
        height: 85%;
        margin: 5px;
        float: left;
        margin: 5px;
        z-index: 1;
    }
    #map {
        width: 35%;
        height: 300px;
        float: left;
        z-index: 2;
        top: 64%;
    }
</style>

<body>
    <form name="naver_maps">
        <input type="text" name="url" tabindex="1" style="width: 960px;" placeholder="https://map.naver.com/v5/?c=" />
        <input type="button" onclick="get_panorama_id()" value="입력">
    </form>

    <div id="pano" z-index: 1;>
        <div id="map" z-index: 2;></div>
    </div>

    <button id="copyBtn">복사하기</button>
    <div id="marker_address" style='display:inline;'></div><br>

    <button id="moveBtn">이동하기</button>
    <div id="now_panorama_url" style='display:inline;'></div>

    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=xbdzrxswyq&submodules=panorama,geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>

        //form 태그에서 파노라마 ID 파싱
        function get_panorama_id() {
            var naver_maps = document.naver_maps;
            var url = naver_maps.url.value;
            panorama_pattern = /(&p=).+\,/.exec(url)[0]
            panorama_value = panorama_pattern.split(',')[0].replace('&p=', '')

            // 파노라마 옵션
            var panoramaOptions = {
                panoId: panorama_value,
                pov: {
                    pan: -130.8,
                    tilt: -9.6,
                    fov: 100
                },
                visible: true,
                aroundControl: true,
                minScale: 0,
                maxScale: 10,
                minZoom: 0,
                maxZoom: 4,
                logoControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_LEFT,
                    style: naver.maps.ZoomControlStyle.SMALL
                },
            };

            //파노라마 ID값을 이용하여 거리뷰 호출
            var panorama = new naver.maps.Panorama("pano", panoramaOptions);
            var map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(panorama.getPosition()),
                zoom: 18,
                mapTypeControlOptions: {
                    style: naver.maps.MapTypeControlStyle.DROPDOWN
                }
            });
            // 거리뷰 레이어를 생성합니다.
            var streetLayer = new naver.maps.StreetLayer();
            naver.maps.Event.once(map, 'init_stylemap', function () {
                streetLayer.setMap(map);
            });

            // 거리뷰 레이어가 변경되면 발생하는 이벤트를 지도로부터 받아 버튼의 상태를 변경합니다.
            naver.maps.Event.addListener(map, 'streetLayer_changed', function (streetLayer) {
                if (streetLayer) {
                    btn.addClass('control-on');
                } else {
                    btn.removeClass('control-on');
                }
            });

            // 지도를 클릭했을 때 발생하는 이벤트를 받아 파노라마 위치를 갱신합니다. 이때 거리뷰 레이어가 있을 때만 갱신하도록 합니다.
            naver.maps.Event.addListener(map, 'rightclick', function (e) {
                if (streetLayer.getMap()) {
                    var latlng = e.coord;
                    // 파노라마의 setPosition()은 해당 위치에서 가장 가까운 파노라마(검색 반경 300미터)를 자동으로 설정합니다.
                    panorama.setPosition(latlng);
                }
            });

            //네이버지도 마커 표시 (거리뷰 이동시)
            var position = new naver.maps.LatLng(panorama.getPosition());
            var marker = new naver.maps.Marker({
                position: position,
                map: map
            });

            //거리뷰 pano_changed 이벤트 발생시 네이버 지도 실행
            naver.maps.Event.addListener(panorama, 'pano_changed', function () {
                var now_panorama_url = '';

                var latlng = panorama.getPosition();
                var now_panorama_location = panorama.getPosition()._lat + ',' + panorama.getPosition()._lng;

                //현재 거리뷰 링크 표시
                var now_panorama_url = "https://map.naver.com/v5/?c=14185421.9777121,4477822.3462987,17,0,0,0,dha&p="
                now_panorama_url = now_panorama_url + panorama.getPanoId() + ',0,0,80,Float';

                //GPS + 주소값 html 출력
                var panorama_url_print = document.getElementById('now_panorama_url');
                panorama_url_print.innerHTML = now_panorama_url;


                //거리뷰 이동시 위치값 전송
                $(function () {
                    var ajax = $.ajax({
                        type: "GET",
                        url: "naver_gps_travle.php?gps=" + now_panorama_location
                    });
                    ajax.done(function (now_panorama_location) {
                        $(".console-area").html(now_panorama_location);
                    });
                });

                //마커 가운데 맞춤
                marker.setPosition(panorama.getPosition())

                //마커 클릭시 마커 이동 및 좌표 반환)
                map.addListener('click', function (e) {
                    var marker_address = null;
                    var marker_latlng = e.coord;

                    //좌표 값에 마커 옮기기
                    marker.setPosition(e.coord);

                    //리버스 지오코딩
                    naver.maps.Service.reverseGeocode({
                        location: new naver.maps.LatLng(marker_latlng),
                    }, function (status, response) {
                        if (status !== naver.maps.Service.Status.OK) {
                            return alert('Something wrong!');
                        }
                        var result = response.result,
                            items = result.items;
                        marker_address = items[0]['address'];

                        //GPS + 주소값 html 출력
                        var resultDiv = document.getElementById('marker_address');
                        marker_gps_address = marker_address + '\t' + e.coord._lat + '\t' + e.coord._lng;
                        resultDiv.innerHTML = marker_gps_address;

                        //복사하기 이벤트
                        var copyBtn = document.getElementById("copyBtn");
                        copyBtn.addEventListener("click", function () {
                            var createInput = document.createElement("input");
                            createInput.setAttribute("type", "marker_gps_address");
                            document.getElementById("copyBtn").appendChild(createInput);
                            createInput.value = marker_gps_address;
                            createInput.select();
                            document.execCommand('copy');
                            document.getElementById("copyBtn").removeChild(createInput);
                        });
                    });
                });

                //클릭한 마커의 GPS좌표
                var resultDiv = document.getElementById('marker_address');
                resultDiv.innerHTML = '';

                //지도와 거리뷰 가운데 맞춤
                if (!latlng.equals(map.getCenter())) {
                    map.setCenter(panorama.getPosition());
                }
            });
        }
            //네이버맵으로 이동하기
    var moveBtn = document.getElementById("moveBtn");
        moveBtn.addEventListener("click", function () {
        now_panorama_url = document.getElementById("now_panorama_url").innerText;
        console.log(now_panorama_url)
        window.open(now_panorama_url,'_blank')
    });
    </script>
</body>

</html>